import { Callout } from 'nextra/components'
import Image from '../../../components/Image'

import { FileTree } from 'nextra/components'




# SkyU Kustomize Transformer

SkyU uses a Kustomize transform plugin to add the necessary configurations for the SkyU platform to manage the resources. This plugin is automatically applied to the merged Kubernetes manifests before deploying them to the environment.

The folder structure of the Kustomize plugin is as follows:

```
|-- kustomize
|   |-- base
|   |   |-- deployment.yaml
|   |-- overlays
|   |   |-- dev
|   |   |   |-- deployment-patch.yaml
|   |   |   |-- skyu-transform.yaml
|   |   |-- staging
|   |   |   |-- deployment-patch.yaml
|   |   |   |-- skyu-transform.yaml
|   |   |-- prod
|   |   |   |-- deployment-patch.yaml
|   |   |   |-- skyu-transform.yaml
```

<Callout type="info">
Please note that `kustomization.yaml` is not required in the plugin folder structure. This yaml is automatically generated by SkyU at runtime.
</Callout>

<Image src="/assets/images/root/merging-example.png" alt="Hello" width={1000} height={500}  />


## Kustomize File Merge

SkyU uses Kustomize to manage the Kubernetes manifests in the GitOps repository. Kustomize allows you to customize Kubernetes resources through a Kubernetes-style configuration file. 

When you create a project in SkyU, SkyU creates a GitOps repository for you. This repository contains the base and overlay folders. The base folder contains the base Kubernetes manifests for your applications and infrastructure. The overlay folders contain the environment-specific configurations for your applications and infrastructure.

When you deploy an application or infrastructure in SkyU, SkyU merges the base and overlay folders using Kustomize. This allows you to customize the Kubernetes resources for different environments without duplicating the base Kubernetes manifests.

After the initial merge, it would go through another transform via a SkyU Kustomize transform plugin to add the necessary configurations for the SkyU platform to manage the resources.

<Image src="/assets/images/root/kustomize-merge.png" alt="Hello" width={1000} height={500}  />

The manifest spec for the  `skyu-transform` plugin is as follows:

```yaml
spec:
  type: "Deployment" # Job, CronJob, Deployment
  applicationContainers:
    - name: "app-container-1"
      applicationPorts:
        - protocol: "TCP"
          port: 8080
          targetPort: 8080
          apiSpec:
            gitPath: "path/to/api/repo"
            urlPath: "/api/v1"
      imageRegistry: "docker.io"
      imageTag: "latest"
      cpuRequestMili: 500
      cpuLimitMili: 1000
      memoryRequestMb: 512
      memoryLimitMb: 1024
      command:
        - "/start.sh"
      args:
        - "--config=/etc/config.yaml"
      healthChecks:
        - initialDelaySeconds: 10
          timeoutSeconds: 5
          periodSeconds: 15
          successThreshold: 1
          failureThreshold: 3
          httpGet:
            path: "/healthz"
            port: 8080
            httpHeaders:
              - name: "Authorization"
                value: "Bearer token"
            scheme: "HTTP"
      configMounts:
        - mountPath: "/etc/config.yaml"
          isFile: true
          configMapName: "app-config"
          key: "config.yaml"
      imagePullPolicy: "IfNotPresent"
      credentialId: "docker-registry-cred"
      imagePullSecretName: "docker-secret"
      commitDetails:
        commitHash: "abcd1234"
        commitTime: "2024-08-22T12:34:56Z"
        commitUser: "john.doe"
        commitMessage: "Initial commit"
        commitAvatar: "https://example.com/avatar.png"
  minReplicas: 2
  maxReplicas: 5
  terminationGracePeriodSeconds: 30
  nodeSelector:
    disktype: "ssd"
  serviceType: "ClusterIP"
  namespace: "default"
  cronTab: "*/5 * * * *"
  suspend: false
  ttlSecondsAfterFinished: 3600
  serviceAccountName: "app-service-account"
  name: "my-application"
  version: "v1.0.0"
  labels:
    app: "my-application"
    environment: "production"
  horizontalAutoScalingRules:
    - ruleType: "cpu"
      percentage: 80
    - ruleType: "memory"
      percentage: 70
  volumes:
    - name: "app-volume"
      type: "pvc"
      pvc:
        claimName: "app-pvc"
        yamlFilePath: "path/to/pvc.yaml"
      volumeMounts:
        - containerName: "app-container-1"
          mountPath: "/data"
```
